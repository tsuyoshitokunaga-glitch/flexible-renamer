<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="請求書・領収書・商品画像のファイル名を3秒で一括変更。電子帳簿保存法対応の命名規則にも。サーバーに送信しない完全ローカル処理で機密情報も安全。インストール不要・無料。">
  <title>ファイル名を一括変更｜請求書・画像・PDFのリネームツール【無料】CloudRename</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://js.hcaptcha.com/1/api.js?onload=onHCaptchaLoad&render=explicit" async defer></script>
  <style>
    .ghost {
      opacity: 0.5;
      background: #f3f4f6;
      border: 2px dashed #d1d5db;
    }

    .drag-over {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }

    /* ボタンが無効化された時のスタイル */
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3J3HTSGRTM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3J3HTSGRTM');
</script>
</head>

<body class="bg-gray-100 min-h-screen p-8 text-gray-800 font-sans relative">

  <!-- Loading Overlay for Stripe Checkout Success -->
  <div id="stripeCheckoutLoading" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[100]">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 text-center">
      <div class="mb-4">
        <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-gray-900 mb-2">決済情報を確認中...</h3>
      <p class="text-sm text-gray-600">少々お待ちください</p>
      <p id="stripeCheckoutStatus" class="text-xs text-gray-500 mt-2"></p>
    </div>
  </div>

  <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6">

    <!-- Header -->
    <header class="mb-6 border-b pb-4 flex justify-between items-start">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">CloudRename</h1>
        <p class="text-gray-600">
          <span class="font-bold text-gray-800 text-lg">画像・PDF・Office・動画。「あらゆるファイル」を3秒で整理。</span><br>
          商品画像から、請求書、プレゼン資料、動画素材まで。<br>
          面倒なリネーム作業を一括自動化し、ブラウザ完結で<span class="font-bold text-blue-600">機密データも安全</span>に処理します。
        </p>
      </div>
      <!-- Auth & Plan Badge -->
      <div class="flex flex-col items-end gap-2">
        <!-- Guest State (shown when not logged in) -->
        <div id="guestContainer" class="flex items-center gap-3">
          <div class="text-right">
            <p class="text-xs text-gray-500">ゲスト利用中</p>
            <p class="text-sm">残り: <span id="guestRemaining" class="font-bold text-orange-500">20</span>/20枚</p>
          </div>
          <div class="flex gap-2">
            <button onclick="openLoginModal()"
              class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-3 rounded text-sm transition">ログイン</button>
            <button onclick="openSignupModal()"
              class="bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white font-bold py-1 px-4 rounded text-sm transition shadow-lg">🚀
              無制限へ</button>
          </div>
        </div>
        <!-- Logged-in State (shown when logged in) -->
        <div id="authContainer" class="hidden flex items-center gap-2">
          <span id="userEmail" class="text-sm text-gray-600 truncate max-w-[150px]"></span>
          <button onclick="signOut()" class="text-xs text-gray-500 hover:text-red-500 underline">ログアウト</button>
        </div>
        <div id="planBadge" class="flex flex-col items-end hidden">
          <span id="planName" class="bg-gray-200 text-gray-700 font-bold px-3 py-1 rounded-full text-sm">Free
            Plan</span>
          <p id="usageText" class="text-xs text-gray-500 mt-1">本日利用数: -/20</p>
          <a href="#" onclick="openPremiumModal()" class="text-xs text-blue-500 hover:underline mt-1">プラン変更</a>
        </div>
      </div>
    </header>

    <!-- Hero Section -->
    <section class="mb-8 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <div class="md:flex">
        <!-- Left Column: Before/After Image -->
        <div class="md:w-1/2 bg-gray-50 p-6 flex items-center justify-center">
          <img src="hero-image.png" 
               alt="画像・PDFを一括整理するビフォーアフター" 
               class="w-full max-w-md rounded-lg shadow-md">
        </div>
        
        <!-- Right Column: Catch Copy & Benefits -->
        <div class="md:w-1/2 p-6 md:p-8 flex flex-col justify-center">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">バラバラのファイル名を、3秒で整理。</h2>
          <ul class="space-y-3 mb-4">
            <li class="flex items-start gap-2">
              <span class="text-green-500 text-lg">✅</span>
              <span class="text-gray-700">画像・PDFをドラッグ＆ドロップで一括変換</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-green-500 text-lg">✅</span>
              <span class="text-gray-700">連番、日付、接頭辞などルールは自由自在</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-green-500 text-lg">✅</span>
              <span class="text-gray-700"><strong>完全ローカル処理</strong>。ファイルはサーバーに送信されず、情報漏洩のリスクがありません</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-green-500 text-lg">✅</span>
              <span class="text-gray-700">インストール不要で、今すぐ使えます</span>
            </li>
          </ul>
          
          <!-- Mini Drop Zone -->
          <div class="drop-zone-target mt-4 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400 hover:bg-gray-50 transition flex flex-col items-center justify-center bg-white">
            <p class="drop-zone-text text-xs text-gray-500 font-medium">ここにファイルをドロップ</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Security Assurance Section -->
    <section class="mb-8 bg-green-50 border border-green-200 rounded-xl p-6 flex flex-col md:flex-row items-center gap-6">
      <div class="flex-shrink-0 bg-white p-4 rounded-full shadow-sm">
        <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
        </svg>
      </div>
      <div class="flex-grow">
        <h3 class="text-lg font-bold text-green-900 mb-2">機密文書も安心の「完全ローカル処理」</h3>
        <p class="text-sm text-green-800 leading-relaxed">
          当ツールは、JavaScript技術により<span class="font-bold underline">すべての処理をお客様のブラウザ（端末内）だけで完結</span>させます。<br>
          画像やPDFなどのファイルデータが、外部のサーバーに送信・保存されることは技術的に一切ありません。<br>
          社外秘の契約書や、プライベートな写真も、安心してご利用いただけます。
        </p>
      </div>
    </section>

    <!-- Drop Zone -->
    <section class="mb-8">
      <div id="dropZone" class="drop-zone-target border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-gray-50 transition flex flex-col items-center justify-center h-32">
        <p class="drop-zone-text text-gray-500 font-medium">ファイルをここにドラッグ＆ドロップ</p>
        <input type="file" id="fileInput" class="hidden" multiple>
      </div>
      <p class="text-xs text-center text-gray-400 mt-2 flex items-center justify-center gap-1">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
        アップロードされたファイルはネットワークを経由せず、あなたの端末内でのみ処理されます
      </p>
    </section>

    <!-- User Guide (New) -->
    <section class="mb-8 bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r text-sm text-blue-900">
      <h3 class="font-bold text-lg mb-2 flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        ご利用ガイド
      </h3>
      <ol class="list-decimal list-inside space-y-1 ml-1 mb-4">
        <li><span class="font-semibold">リネーム設定</span>を入力します（先頭・末尾文字、連番のルールなど）。</li>
        <li>ファイルを <span class="font-semibold">ドロップゾーン</span> にドラッグ＆ドロップしてアップロードします。</li>
        <li>ファイルの順番は、<span class="font-semibold">ドラッグ</span> または <span class="font-semibold">No.の手入力</span> で変更できます。</li>
        <li>個別に名前を指定したい場合は、ファイル右側の「手入力」を選択して入力します。</li>
        <li><span class="font-semibold">「ダウンロード」</span>ボタンを押して完了です。</li>
      </ol>
      <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 text-yellow-800 text-xs">
        <p class="font-bold flex items-center mb-1">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
          Web画像の直接ドロップについて
        </p>
        <p>
          Webサイト上の画像を直接ドラッグ＆ドロップで追加できますが、サイトのセキュリティ設定（CORS）によっては読み込めない場合があります。<br>
          エラーが出る場合は、一度パソコンに画像を保存してからアップロードしてください。
        </p>
      </div>
      <div class="pt-4 border-t border-blue-200 text-xs text-blue-800">
        <p class="mb-1"><span class="font-bold">対応拡張子:</span> すべてのファイル形式（jpg, png, pdf, xlsx, docx, mp4, movなど）</p>
        <p><span class="font-bold">推奨環境:</span> Google Chrome, Edge, Firefox, Safari (最新版)</p>
      </div>
    </section>

    <!-- Pricing Section -->
    <section id="pricing" class="mb-8">
      <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
        <svg class="w-5 h-5 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
          <path
            d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
        料金プラン
      </h3>
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Free Plan -->
        <div class="bg-white border border-gray-200 rounded-xl p-6 relative">
          <h4 class="text-xl font-bold text-gray-800 mb-2">Free / ゲストプラン</h4>
          <p class="text-3xl font-bold text-gray-900 mb-4">¥0<span class="text-sm font-normal text-gray-500"> / 月</span>
          </p>
          <ul class="text-sm text-gray-600 space-y-2 mb-6">
            <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>1日20枚まで利用可能</li>
            <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>基本的なリネーム・ZIP化</li>
            <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-gray-300" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg><span class="text-gray-400">回数制限あり</span></li>
          </ul>
          <button id="freePlanBtn" onclick="openLoginModal()"
            class="w-full py-2 px-4 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition">
            ログインして使う
          </button>
        </div>
        <!-- Premium Plan -->
        <div
          class="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-400 rounded-xl p-6 relative shadow-lg">
          <span
            class="absolute -top-3 left-4 bg-gradient-to-r from-orange-500 to-pink-500 text-white text-xs font-bold px-3 py-1 rounded-full">✨
            おすすめ</span>
          <h4 class="text-xl font-bold text-gray-800 mb-2 mt-2">Premium Plan</h4>
          <p class="text-3xl font-bold text-blue-600 mb-4">¥990<span class="text-sm font-normal text-gray-500"> / 月
              (税込)</span></p>
          <ul class="text-sm text-gray-700 space-y-2 mb-6">
            <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg><span class="font-bold text-blue-700">回数無制限</span></li>
            <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>業務効率化に最適</li>
            <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>優先サポート</li>
          </ul>
          <button id="premiumCTA" onclick="handlePremiumCTA()"
            class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">
            🚀 月額990円で無制限にする
          </button>
        </div>
      </div>
    </section>

    <!-- Additional Drop Zone -->
    <section class="mb-8">
      <div class="drop-zone-target border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-400 hover:bg-gray-50 transition flex flex-col items-center justify-center bg-white shadow-sm">
        <p class="drop-zone-text text-gray-500 font-medium flex items-center justify-center gap-2">
          <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
          ここにファイルを追加（ドラッグ＆ドロップ）
        </p>
      </div>
    </section>

    <!-- Settings Section -->
    <section id="renameSettings" class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
      <h3 class="text-lg font-bold text-gray-800 mb-4">リネーム設定</h3>
      <div class="grid gap-6 md:grid-cols-4 items-end">

        <!-- Prefix -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">先頭文字列 (固定)</label>
          <input type="text" id="prefix" placeholder="例: IMG_"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
            oninput="updateFilenames()">
        </div>

        <!-- Sequence Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">連番タイプ</label>
          <select id="seqType"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
            onchange="updateFilenames(); toggleMinDigits();">
            <option value="number">数字 (1, 2, ...)</option>
            <option value="alphabet-upper">英字 大文字 (A, B...)</option>
            <option value="alphabet-lower">英字 小文字 (a, b...)</option>
          </select>
        </div>

        <!-- Start Number -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">開始番号</label>
          <input type="number" id="startNumber" value="1" min="0"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
            oninput="updateFilenames()">
        </div>

        <!-- Min Digits -->
        <div id="minDigitsContainer">
          <label class="block text-sm font-medium text-gray-700 mb-1">最小桁数 (1-12)</label>
          <input type="number" id="minDigits" value="3" min="1" max="12"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
            oninput="updateFilenames()">
        </div>

        <!-- Suffix -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">末尾文字列 (固定)</label>
          <input type="text" id="suffix" placeholder="例: _v1"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
            oninput="updateFilenames()">
        </div>

      </div>

      <!-- Output Preview -->
      <div class="mt-6 pt-4 border-t border-gray-200">
        <p class="text-sm font-medium text-gray-700 mb-2">出力ファイル名プレビュー:</p>
        <div class="bg-white p-3 rounded-lg border border-gray-300 font-mono text-sm text-gray-800">
          <span class="text-gray-400">(例)</span> <span id="previewFilename">IMG_001_v1.jpg</span>
        </div>
      </div>
    </section>

    <!-- Management Section -->
    <section class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">ファイルリスト <span id="imageCount"
            class="text-sm font-normal text-gray-500 ml-2">(0点)</span></h2>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <select id="downloadFormat" class="text-xs px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
              <option value="zip">ZIPにまとめて保存</option>
              <option value="individual">そのままダウンロード</option>
            </select>
            <div class="flex items-center gap-1">
              <button onclick="downloadFiles()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transform active:scale-95 transition flex items-center text-sm">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                ダウンロード
              </button>
              <div id="downloadFormatNotice" class="hidden flex items-center gap-1 text-xs text-gray-500 ml-1">
                <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>複数ファイルの保存許可が必要です</span>
              </div>
            </div>
          </div>
          <button onclick="clearAll()"
            class="text-red-500 hover:text-red-700 text-sm font-medium hover:underline">全削除</button>
        </div>
      </div>

      <div id="imageList" class="grid grid-cols-1 gap-4">
        <!-- Images will be inserted here -->
      </div>

      <div id="emptyState" class="text-center py-12 bg-gray-50 rounded-lg border border-gray-200">
        <p class="text-gray-400">ファイルがありません</p>
      </div>
    </section>

    <!-- Output Section -->
    <section class="border-t pt-6">
      <div class="flex flex-col items-end gap-2">
        <div class="flex flex-col items-end gap-2">
          <div class="flex items-center gap-3">
            <select id="downloadFormatBottom" class="text-sm px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
              <option value="zip">ZIPにまとめて保存</option>
              <option value="individual">そのままダウンロード</option>
            </select>
            <div class="flex items-center gap-1">
              <button onclick="downloadFiles()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform active:scale-95 transition flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                ダウンロード
              </button>
              <div id="downloadFormatNoticeBottom" class="hidden flex items-center gap-1 text-xs text-gray-500 ml-1">
                <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>複数ファイルの保存許可が必要です</span>
              </div>
            </div>
          </div>
        </div>
        <!-- CTA Link (changes based on login state) -->
        <p id="ctaLink" class="text-xs text-gray-500">
          <a href="#" onclick="openLoginModal()" class="text-blue-500 hover:underline">ログインすると履歴が保存されます</a>
        </p>
      </div>
    </section>

    <!-- Auth Modal -->
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full mx-4 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">ログイン</h2>
        <div id="loginDuplicateAlert"
          class="hidden bg-red-50 border border-red-200 p-4 rounded-lg mb-6 flex items-center gap-3">
          <span class="text-2xl">⚠️</span>
          <p class="text-red-800 text-sm font-bold leading-relaxed">このメールアドレスは既に登録されています。<br>パスワードを入力してログインしてください。</p>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">メールアドレス</label>
            <input type="email" id="loginEmail"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">パスワード</label>
            <input type="password" id="loginPassword"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div id="loginCaptcha" class="h-captcha flex justify-center my-6 min-h-[78px]"
            data-sitekey="7832e338-aed6-413c-9aba-7fa6ef465c64"></div>
          <div class="pt-2">
            <button id="loginBtn" onclick="signIn()"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition">ログイン</button>
          </div>
          <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t border-gray-200"></div>
            <span class="flex-shrink mx-4 text-gray-400 text-xs">または</span>
            <div class="flex-grow border-t border-gray-200"></div>
          </div>
          <button onclick="switchToSignup()"
            class="w-full bg-white hover:bg-green-50 text-green-600 border-2 border-green-500 font-bold py-3 rounded-lg transition flex items-center justify-center gap-2">
            <span>🚀</span> 新規会員登録はこちら（無料）
          </button>
          <div class="text-center pt-2">
            <button onclick="resetPassword()" class="text-xs text-blue-500 hover:underline">パスワードをお忘れですか？</button>
          </div>
          <p id="loginMessage" class="text-xs text-red-500 text-center min-h-[1.5em] mt-4"></p>
        </div>
      </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full mx-4 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeSignupModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">新規登録</h2>
        <div id="signupLimitAlert"
          class="hidden bg-red-50 border border-red-200 p-4 rounded-lg mb-4 flex items-center gap-3">
          <span class="text-2xl">⚠️</span>
          <p class="text-red-800 text-sm font-bold">20枚以上を一括変換するには、Premiumプラン（月額990円）への登録が必要です。</p>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">メールアドレス</label>
            <input type="email" id="signupEmail"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">パスワード</label>
            <input type="password" id="signupPassword"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
            <ul class="text-xs text-gray-500 mt-2 space-y-1 list-disc list-inside">
              <li>8文字以上</li>
              <li>英字（大文字・小文字）を含む</li>
              <li>数字を含む</li>
            </ul>
          </div>
          <div id="signupCaptcha" class="h-captcha flex justify-center my-6 min-h-[78px]"
            data-sitekey="7832e338-aed6-413c-9aba-7fa6ef465c64"></div>
          <div class="pt-2">
            <button id="signupBtn" onclick="signUp()"
              class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition">登録する</button>
          </div>
          <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t border-gray-200"></div>
            <div class="flex-grow border-t border-gray-200"></div>
          </div>
          <button onclick="switchToLogin()"
            class="w-full bg-gray-50 hover:bg-gray-100 text-gray-600 font-bold py-3 rounded-lg transition flex items-center justify-center gap-2">
            <span>🔑</span> すでにアカウントをお持ちの方はログイン
          </button>
          <p id="signupMessage" class="text-xs text-red-500 text-center min-h-[1.5em] mt-4"></p>
        </div>
      </div>
    </div>

    <!-- Premium Modal -->
    <div id="premiumModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 relative transform transition-all scale-100">
        <button onclick="closePremiumModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>

        <!-- Pattern A: Free Plan (Default) -->
        <div id="premiumModalFree" class="text-center">
          <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z">
              </path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Premium Plan</h2>
          <p id="premiumMessage" class="text-sm text-red-600 mb-4 font-bold"></p>
          <p class="text-gray-600 mb-6">無料プランは1日20枚までです。<br>制限なしで利用するにはアップグレードが必要です。</p>

          <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <p class="text-3xl font-bold text-gray-800">¥990<span class="text-sm text-gray-500 font-normal"> / 月
                (税込)</span></p>
          </div>

          <button onclick="subscribeToPremium(this)"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg mb-3">
            今すぐ登録する
          </button>
        </div>

        <!-- Pattern B: Premium Active -->
        <div id="premiumModalActive" class="hidden">
          <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">ご契約内容の確認</h2>
          <div class="space-y-4 mb-6">
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600 mb-1">現在のプラン</p>
              <p class="text-xl font-bold text-gray-900">Premium Plan</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600 mb-1">次回の更新日</p>
              <p id="premiumNextBillingDate" class="text-xl font-bold text-gray-900">-</p>
              <p class="text-xs text-gray-500 mt-1">（自動更新）</p>
            </div>
          </div>
          <button id="openPortalBtn" onclick="openPortal(this)"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg mb-4">
            領収書・支払い履歴の確認（Stripe）
          </button>
          <div class="text-center pt-4 border-t border-gray-200">
            <button onclick="cancelSubscription(this)" class="text-xs text-gray-500 hover:text-red-600 underline">
              解約をご希望の方はこちら
            </button>
          </div>
        </div>

        <!-- Pattern C: Premium Canceled -->
        <div id="premiumModalCanceled" class="hidden">
          <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">ご契約内容の確認</h2>
          <div class="space-y-4 mb-6">
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600 mb-1">現在のプラン</p>
              <p class="text-xl font-bold text-gray-900">Premium Plan<span class="text-sm font-normal text-red-600 ml-2">（解約済み）</span></p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600 mb-1">有効期限</p>
              <p id="premiumExpiryDate" class="text-xl font-bold text-gray-900">-</p>
              <p class="text-xs text-gray-500 mt-1">まで利用可能</p>
            </div>
          </div>
          <button id="resumeSubscriptionBtn" onclick="resumeSubscription(this)"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg mb-3">
            サブスクリプションを再開する
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-8 pt-8 border-t border-gray-100 text-center">
      <div class="flex justify-center gap-4 mb-2">
        <button onclick="openLegalModal()" class="text-xs text-gray-400 hover:text-blue-500 underline transition">
          特定商取引法に基づく表記
        </button>
        <span class="text-xs text-gray-400">|</span>
        <button onclick="openContactModal()" class="text-xs text-gray-400 hover:text-blue-500 underline transition">
          お問い合わせ
        </button>
        <span class="text-xs text-gray-400">|</span>
        <a href="privacy.html" class="text-xs text-gray-400 hover:text-blue-500 underline transition">
          プライバシーポリシー
        </a>
      </div>
      <p class="text-[10px] text-gray-300 mt-2">© 2024 CloudRename</p>
    </footer>

  </div>

  <!-- Legal Modal (Specified Commercial Transactions Act) -->
  <div id="legalModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[60]">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full mx-4 relative max-h-[90vh] overflow-y-auto">
      <button onclick="closeLegalModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <h2 class="text-xl font-bold text-gray-900 mb-6 border-b pb-2">特定商取引法に基づく表記</h2>

      <div class="space-y-6 text-sm text-gray-700 leading-relaxed">
        <section>
          <h3 class="font-bold text-gray-900 mb-1">販売業者の名称</h3>
          <p>CloudRename 徳永 剛</p>
        </section>

        <section>
          <h3 class="font-bold text-gray-900 mb-1">運営統括責任者</h3>
          <p>徳永 剛</p>
        </section>

        <section>
          <h3 class="font-bold text-gray-900 mb-1">所在地</h3>
          <p>兵庫県尼崎市上坂部1-2-2-133</p>
        </section>

        <section>
          <h3 class="font-bold text-gray-900 mb-1">連絡先</h3>
          <p>info@shopify-spreadsheet.com</p>
        </section>

        <section>
          <h3 class="font-bold text-gray-900 mb-1">販売価格</h3>
          <p>Premiumプラン 月額990円</p>
        </section>

        <section>
          <h3 class="font-bold text-gray-900 mb-1">支払方法</h3>
          <p>クレジットカード</p>
        </section>

        <section>
          <h3 class="font-bold text-gray-900 mb-1">解約・キャンセルについて</h3>
          <p>毎月の契約日と同じ日にちに自動更新となります。契約後の途中解約はできません。自動更新を停止するには停止の手続きを進めてください。自動更新停止の手順は<a href="#" class="text-blue-500 hover:underline" onclick="event.preventDefault(); openCancellationGuideModal();">こちら</a></p>
        </section>
      </div>

      <div class="mt-8 pt-4 border-t border-gray-100">
        <button onclick="closeLegalModal()"
          class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-2 rounded-lg transition">
          閉じる
        </button>
      </div>
    </div>
  </div>

  <!-- Cancellation Guide Modal -->
  <div id="cancellationGuideModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[70]">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full mx-4 relative max-h-[90vh] overflow-y-auto">
      <button onclick="closeCancellationGuideModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <h2 class="text-xl font-bold text-gray-900 mb-6 border-b pb-2">自動更新停止の手順</h2>

      <div class="space-y-6 text-sm text-gray-700 leading-relaxed">
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r">
          <p class="text-sm text-blue-900 font-semibold mb-2">以下の手順で自動更新を停止できます：</p>
          <ol class="list-decimal list-inside space-y-3 text-gray-800">
            <li>ログインした状態で、画面右上の「契約確認」ボタンをクリックします。</li>
            <li>表示された画面内の「サブスクリプションを解約する（自動更新を停止）」ボタンをクリックします。</li>
            <li>確認ダイアログで「OK」を選択すると、次回の自動更新が停止されます。</li>
          </ol>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <p class="text-xs text-gray-600">
            <strong>注意:</strong> 解約後も有効期限まではPremiumプランの機能をご利用いただけます。有効期限を過ぎると、自動的にFreeプランに戻ります。
          </p>
        </div>
      </div>

      <div class="mt-8 pt-4 border-t border-gray-100">
        <button onclick="closeCancellationGuideModal()"
          class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-2 rounded-lg transition">
          閉じる
        </button>
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[70]">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full mx-4 relative max-h-[90vh] overflow-y-auto">
      <button onclick="closeContactModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <h2 class="text-xl font-bold text-gray-900 mb-6 border-b pb-2">お問い合わせ</h2>

      <form id="contactForm" onsubmit="submitInquiry(event); return false;" class="space-y-4">
        <div>
          <label for="contactSubject" class="block text-sm font-medium text-gray-700 mb-1">件名 <span class="text-red-500">*</span></label>
          <input type="text" id="contactSubject" name="subject" required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="お問い合わせの件名を入力してください">
        </div>

        <div>
          <label for="contactMessage" class="block text-sm font-medium text-gray-700 mb-1">お問い合わせ内容 <span class="text-red-500">*</span></label>
          <textarea id="contactMessage" name="message" required rows="6"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
            placeholder="お問い合わせ内容を入力してください"></textarea>
        </div>

        <div class="pt-4 border-t border-gray-100">
          <button type="submit" id="contactSubmitBtn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition">
            送信する
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Template for List Item -->
  <template id="imageItemTemplate">
    <div
      class="image-item bg-white border border-gray-200 rounded-lg p-4 shadow-sm flex items-center gap-4 hover:shadow-md transition group">

      <!-- Drag Handle & Sort Input -->
      <div class="flex flex-col items-center gap-2 mr-2">
        <div class="cursor-move text-gray-300 hover:text-gray-500 p-1">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
          </svg>
        </div>
        <!-- Manual Sort Input -->
        <input type="number"
          class="sort-input w-12 text-center text-sm border border-gray-300 rounded p-1 focus:ring-2 focus:ring-blue-500 outline-none"
          value="1" onchange="manualSort(this)">
      </div>

      <div class="w-20 h-20 bg-gray-100 rounded-md overflow-hidden flex-shrink-0 border border-gray-200 relative">
        <img src="" alt="Thumbnail" class="w-full h-full object-contain">
      </div>

      <div class="flex-grow grid md:grid-cols-2 gap-4">
        <div>
          <div class="flex items-center gap-2 mb-2">
            <label class="inline-flex items-center cursor-pointer">
              <input type="radio" name="mode-{id}" value="default" class="sr-only peer" checked
                onchange="updateRowMode(this)">
              <div
                class="px-3 py-1 rounded-full text-xs font-medium border border-blue-500 text-blue-600 peer-checked:bg-blue-500 peer-checked:text-white transition">
                連番</div>
            </label>
            <label class="inline-flex items-center cursor-pointer">
              <input type="radio" name="mode-{id}" value="custom" class="sr-only peer" onchange="updateRowMode(this)">
              <div
                class="px-3 py-1 rounded-full text-xs font-medium border border-purple-500 text-purple-600 peer-checked:bg-purple-500 peer-checked:text-white transition">
                手入力</div>
            </label>
          </div>

          <div class="custom-input-container hidden">
            <input type="text" placeholder="手入力テキスト"
              class="w-full text-sm px-2 py-1 border border-purple-200 rounded focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none"
              oninput="updateFilenames()">
            <p class="text-xs text-gray-400 mt-1">※ 先頭・末尾文字列は付与されます</p>
          </div>
        </div>

        <div class="flex flex-col justify-center">
          <p class="text-xs text-gray-400 mb-1">変更後のファイル名:</p>
          <p class="filename-preview font-mono text-sm font-bold text-gray-800 break-all select-all">pending...</p>
          <p class="text-xs text-gray-400 mt-1 truncate original-name"></p>
        </div>
      </div>

      <button onclick="removeImage(this)"
        class="p-2 text-gray-400 hover:text-red-500 rounded-full hover:bg-red-50 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
          </path>
        </svg>
      </button>
    </div>
  </template>

  <script>
    let imageData = [];
    const listContainer = document.getElementById('imageList');
    let currentUser = null;
    let currentUsage = { daily_count: 0, is_premium: false, subscription_status: null, next_billing_date: null };

    // hCaptcha Widget IDs for explicit reset
    let loginCaptchaId = null;
    let signupCaptchaId = null;

    // --- Supabase Configuration ---
    const supabaseUrl = 'https://dewwtecteezjvpqoqirv.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRld3d0ZWN0ZWV6anZwcW9xaXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MjkxNDgsImV4cCI6MjA4MzAwNTE0OH0.uC5LgVMDKEoCyz4M4ZL1biTRCrN6e5zVyo77yEuUHgQ';
    // Initialize Supabase Client
    // Note: using checking if window.supabase exists, for robustness
    let sb = null;
    if (window.supabase) {
      sb = window.supabase.createClient(supabaseUrl, supabaseKey);
    } else {
      console.error('Supabase library not loaded');
      alert('システムエラー: Supabaseライブラリの読み込みに失敗しました。');
    }

    const FREE_LIMIT = 20;

    // --- Auth Logic ---
    async function initSupabase() {
      if (!sb) return;

      // Check current session
      const { data } = await sb.auth.getSession();
      handleSession(data.session);

      // Listen for changes
      sb.auth.onAuthStateChange((event, session) => {
        handleSession(session);
      });
    }

    async function handleSession(session) {
      currentUser = session?.user || null;
      const guestContainer = document.getElementById('guestContainer');
      const authContainer = document.getElementById('authContainer');
      const planBadge = document.getElementById('planBadge');

      // Close all modals on session change
      closeLoginModal();
      closeSignupModal();

      if (currentUser) {
        // Logged In - Hide guest, show auth
        guestContainer.classList.add('hidden');
        authContainer.classList.remove('hidden');
        document.getElementById('userEmail').textContent = currentUser.email;
        planBadge.classList.remove('hidden');
        updatePricingUI(); // Immediate update
        await fetchUsage(); // Get DB data
        updateCTALink();

        // 3. Post-login premium promotion
        if (sessionStorage.getItem('pending_action') === 'premium_promote') {
          if (currentUsage && !currentUsage.is_premium) {
            openPremiumModal();
            document.getElementById('premiumMessage').textContent = '20枚以上の変換を続けるには、プレミアムプランへのアップグレードをご検討ください。';
          }
          sessionStorage.removeItem('pending_action');
        }
      } else {
        // Guest Mode - Show guest, hide auth
        guestContainer.classList.remove('hidden');
        authContainer.classList.add('hidden');
        planBadge.classList.add('hidden');
        updateGuestUsageUI();
        updateCTALink();
        updatePricingUI();
      }
    }

    // --- Guest Usage (localStorage) ---
    function getGuestUsageKey() {
      const today = new Date().toISOString().split('T')[0];
      return `anon_usage_${today}`;
    }

    function getGuestUsage() {
      const key = getGuestUsageKey();
      return parseInt(localStorage.getItem(key) || '0', 10);
    }

    function setGuestUsage(count) {
      const key = getGuestUsageKey();
      localStorage.setItem(key, count.toString());
      updateGuestUsageUI();
    }

    function updateGuestUsageUI() {
      const used = getGuestUsage();
      const remaining = Math.max(0, FREE_LIMIT - used);
      const el = document.getElementById('guestRemaining');
      if (el) {
        el.textContent = remaining;
        // Make it red if low
        if (remaining <= 5) {
          el.className = 'font-bold text-red-500';
        } else if (remaining <= 10) {
          el.className = 'font-bold text-orange-500';
        } else {
          el.className = 'font-bold text-green-500';
        }
      }
    }

    function updateCTALink() {
      const ctaEl = document.getElementById('ctaLink');
      if (!ctaEl) return;
      if (currentUser) {
        if (currentUsage.is_premium) {
          ctaEl.innerHTML = '<span class="text-green-500">✓ Premiumプランをご利用中</span>';
        } else {
          ctaEl.innerHTML = '<a href="#" onclick="openPremiumModal()" class="text-blue-500 hover:underline">無制限プランで制限を解除 →</a>';
        }
      } else {
        ctaEl.innerHTML = '<a href="#" onclick="openLoginModal()" class="text-blue-500 hover:underline">ログインすると履歴が保存されます</a>';
      }
    }

    // --- hCaptcha Explicit Loading ---
    window.onHCaptchaLoad = function () {
      if (typeof hcaptcha !== 'undefined') {
        const loginEl = document.getElementById('loginCaptcha');
        const signupEl = document.getElementById('signupCaptcha');

        if (loginEl) {
          loginCaptchaId = hcaptcha.render('loginCaptcha', {
            sitekey: loginEl.getAttribute('data-sitekey'),
            theme: 'light'
          });
        }

        if (signupEl) {
          signupCaptchaId = hcaptcha.render('signupCaptcha', {
            sitekey: signupEl.getAttribute('data-sitekey'),
            theme: 'light'
          });
        }
      }
    };

    // Helper: Safer Captcha Reset
    function resetAllCaptchas() {
      if (typeof hcaptcha !== 'undefined') {
        try {
          if (loginCaptchaId !== null) hcaptcha.reset(loginCaptchaId);
          if (signupCaptchaId !== null) hcaptcha.reset(signupCaptchaId);
        } catch (e) {
          console.warn('Captcha reset failed:', e);
        }
      }
    }

    function handlePremiumCTA() {
      if (currentUser) {
        openPremiumModal();
      } else {
        openSignupModal();
      }
    }

    // Modal Control
    function openLoginModal() {
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('loginMessage').textContent = '';
      resetAllCaptchas();
      const duplicateAlert = document.getElementById('loginDuplicateAlert');
      if (duplicateAlert) duplicateAlert.classList.add('hidden');
      closeSignupModal();
    }

    function closeLoginModal() {
      document.getElementById('loginModal').classList.add('hidden');
      resetAllCaptchas();
    }

    function openSignupModal() {
      document.getElementById('signupModal').classList.remove('hidden');
      document.getElementById('signupMessage').textContent = '';
      resetAllCaptchas();
      const limitAlert = document.getElementById('signupLimitAlert');
      if (limitAlert) limitAlert.classList.add('hidden');
      closeLoginModal();
    }

    function closeSignupModal() {
      document.getElementById('signupModal').classList.add('hidden');
      resetAllCaptchas();
    }

    function switchToSignup() {
      const duplicateAlert = document.getElementById('loginDuplicateAlert');
      if (duplicateAlert) duplicateAlert.classList.add('hidden');
      openSignupModal();
    }

    function switchToLogin() {
      openLoginModal();
    }

    function openLegalModal() {
      document.getElementById('legalModal').classList.remove('hidden');
    }

    function closeLegalModal() {
      document.getElementById('legalModal').classList.add('hidden');
    }

    function openCancellationGuideModal() {
      document.getElementById('cancellationGuideModal').classList.remove('hidden');
    }

    function closeCancellationGuideModal() {
      document.getElementById('cancellationGuideModal').classList.add('hidden');
    }

    function openContactModal() {
      // Premiumプラン限定のアクセス制限
      if (!currentUsage || !currentUsage.is_premium) {
        alert('お問い合わせはPremiumプラン限定の機能です。');
        return;
      }

      document.getElementById('contactModal').classList.remove('hidden');
      // フォームをリセット
      const form = document.getElementById('contactForm');
      if (form) {
        form.reset();
      }
    }

    function closeContactModal() {
      document.getElementById('contactModal').classList.add('hidden');
      // フォームをリセット
      const form = document.getElementById('contactForm');
      if (form) {
        form.reset();
      }
    }

    async function submitInquiry(event) {
      event.preventDefault();

      const subject = document.getElementById('contactSubject').value.trim();
      const message = document.getElementById('contactMessage').value.trim();

      if (!subject || !message) {
        alert('件名とお問い合わせ内容を入力してください。');
        return;
      }

      // ボタン連打防止
      const btn = document.getElementById('contactSubmitBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '送信中...';

      try {
        // モック送信処理: console.logに出力
        console.log('=== お問い合わせ送信（モック） ===');
        console.log('件名:', subject);
        console.log('内容:', message);
        console.log('送信日時:', new Date().toISOString());
        console.log('ユーザーID:', currentUser?.id || 'N/A');
        console.log('================================');

        // アラート表示とモーダルを閉じる
        alert('お問い合わせを受け付けました。返信まで数日お待ちください。');
        closeContactModal();
      } catch (e) {
        console.error('Submit inquiry error:', e);
        alert('エラーが発生しました。もう一度お試しください。');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // Auth Actions
    async function signIn() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const msg = document.getElementById('loginMessage');
      const btn = document.getElementById('loginBtn');

      if (!email || !password) {
        msg.textContent = 'メールアドレスとパスワードを入力してください';
        return;
      }

      const captchaEl = document.querySelector('#loginModal [name="h-captcha-response"]');
      const token = captchaEl ? captchaEl.value : '';

      if (!token) {
        alert('「私はロボットではありません」にチェックを入れてください');
        return;
      }

      // 防止: ダブルクリック対策
      btn.disabled = true;
      msg.textContent = '処理中...';

      try {
        const { data, error } = await sb.auth.signInWithPassword({
          email,
          password,
          options: { captchaToken: token }
        });

        if (error) {
          msg.textContent = 'ログインエラー: ' + error.message;
          resetAllCaptchas();
        } else {
          msg.textContent = '';
          resetAllCaptchas();
        }
      } finally {
        btn.disabled = false;
      }
    }

    async function signUp() {
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const msg = document.getElementById('signupMessage');
      const btn = document.getElementById('signupBtn');

      if (!email || !password) {
        msg.textContent = 'メールアドレスとパスワードを入力してください';
        return;
      }

      // Password validation
      const hasMinLength = password.length >= 8;
      const hasUppercase = /[A-Z]/.test(password);
      const hasLowercase = /[a-z]/.test(password);
      const hasNumber = /[0-9]/.test(password);

      if (!hasMinLength || !hasUppercase || !hasLowercase || !hasNumber) {
        let errors = [];
        if (!hasMinLength) errors.push('8文字以上');
        if (!hasUppercase || !hasLowercase) errors.push('英字（大文字・小文字）');
        if (!hasNumber) errors.push('数字');
        msg.textContent = `パスワードに以下が必要です: ${errors.join(', ')}`;
        return;
      }

      const captchaEl = document.querySelector('#signupModal [name="h-captcha-response"]');
      const token = captchaEl ? captchaEl.value : '';

      if (!token) {
        alert('「私はロボットではありません」にチェックを入れてください');
        return;
      }

      // 防止: ダブルクリック対策
      btn.disabled = true;
      msg.textContent = '登録処理中...';

      try {
        const { data, error } = await sb.auth.signUp({
          email,
          password,
          options: { captchaToken: token }
        });

        if (error) {
          if (error.status === 422 || error.message.includes('already registered') || error.message.includes('already exists')) {
            msg.textContent = '';
            const signupEmail = document.getElementById('signupEmail').value;
            switchToLogin();
            document.getElementById('loginEmail').value = signupEmail;
            const duplicateAlert = document.getElementById('loginDuplicateAlert');
            if (duplicateAlert) duplicateAlert.classList.remove('hidden');
            resetAllCaptchas();
          } else {
            msg.textContent = '登録エラー: ' + error.message;
            resetAllCaptchas();
          }
        } else {
          msg.textContent = '確認メールを送信しました。メール内のリンクをクリックしてください。';
          resetAllCaptchas();
        }
      } finally {
        btn.disabled = false;
      }
    }

    async function resetPassword() {
      const email = document.getElementById('loginEmail').value;
      const msg = document.getElementById('loginMessage');

      if (!email) {
        msg.textContent = 'リセットするためには、メールアドレスを入力してください';
        return;
      }

      msg.textContent = 'リセットメール送信中...';
      const { data, error } = await sb.auth.resetPasswordForEmail(email);

      if (error) {
        msg.textContent = '送信エラー: ' + error.message;
      } else {
        msg.textContent = 'パスワードリセットメールを送信しました。';
      }
    }

    async function signOut() {
      const { error } = await sb.auth.signOut();
      if (error) console.error('SignOut Error:', error);
    }

    // --- Usage DB Logic ---
    // Helper: Calculate next billing date (mock - 30 days from now)
    function getNextBillingDate() {
      const date = new Date();
      date.setMonth(date.getMonth() + 1);
      return date.toISOString().split('T')[0];
    }

    async function fetchUsage() {
      if (!currentUser || !sb) {
        // ユーザーまたはSupabaseクライアントが存在しない場合はデフォルト値をセット
        const today = new Date().toISOString().split('T')[0];
        currentUsage = { 
          id: currentUser?.id || null, 
          daily_count: 0, 
          last_reset_date: today, 
          is_premium: false,
          subscription_status: null,
          next_billing_date: null
        };
        updateHeaderUI();
        return;
      }
      const today = new Date().toISOString().split('T')[0];

      // デフォルト値を事前にセット（Fail Openの実装）
      let data = { 
        id: currentUser.id, 
        daily_count: 0, 
        last_reset_date: today, 
        is_premium: false,
        subscription_status: null,
        next_billing_date: null
      };

      try {
        // 1. Fetch record
        let fetchResult;
        try {
          fetchResult = await sb
            .from('user_usage')
            .select('*')
            .eq('id', currentUser.id)
            .maybeSingle();
        } catch (fetchErr) {
          // ネットワークエラーやその他のエラーでも続行
          console.error('Usage Init: Fetch error (continuing with defaults):', fetchErr);
          fetchResult = { data: null, error: fetchErr };
        }

        const { data: fetchedData, error: fetchError } = fetchResult;

        // 2. If no record, create default
        if (!fetchedData) {
          // Insert attempt
          let insertResult;
          try {
            insertResult = await sb
              .from('user_usage')
              .insert([{ id: currentUser.id, daily_count: 0, last_reset_date: today, is_premium: false }])
              .select()
              .single();
          } catch (insertErr) {
            // Insertエラーでも続行
            console.error('Usage Init: Insert error (continuing with defaults):', insertErr);
            insertResult = { data: null, error: insertErr };
          }

          const { data: newData, error: insertError } = insertResult;

          if (insertError) {
            console.warn('Usage Init: Insert failed, retrying select after delay...', insertError);

            // ★Wait処理: 1秒待つ（サーバー側の処理完了待ち）
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Retry Select
            let retryResult;
            try {
              retryResult = await sb
                .from('user_usage')
                .select('*')
                .eq('id', currentUser.id)
                .maybeSingle();
            } catch (retryErr) {
              // Retryエラーでも続行
              console.error('Usage Init: Retry select error (continuing with defaults):', retryErr);
              retryResult = { data: null, error: retryErr };
            }

            const { data: retryData, error: retryError } = retryResult;

            if (retryError || !retryData) {
              // ★フォールバック: エラーアラートを出さず、デフォルト値を使う
              console.error('Usage Init: Fatal sync error. Using offline fallback.', retryError);
              // デフォルト値は既にセット済み
            } else {
              data = retryData;
            }
          } else {
            data = newData;
          }
        } else {
          data = fetchedData;
        }

        // 3. Check Daily Reset & Sync Guest Usage
        if (data) {
          // Reset logic
          if (data.last_reset_date !== today) {
            // DB更新を試みるが、失敗してもメモリ上の値を更新して進む
            let updateResult;
            try {
              updateResult = await sb
                .from('user_usage')
                .update({ daily_count: 0, last_reset_date: today })
                .eq('id', currentUser.id);
            } catch (updateErr) {
              // Updateエラーでも続行
              console.error('Usage Init: Update error (continuing with defaults):', updateErr);
              updateResult = { error: updateErr };
            }

            const { error: updateError } = updateResult;

            if (!updateError) {
              data.daily_count = 0;
              data.last_reset_date = today;
            } else {
              // エラー時でもメモリ上の値を更新
              data.daily_count = 0;
              data.last_reset_date = today;
            }
          }

          // Guest sync logic
          const guestUsed = getGuestUsage();
          if (guestUsed > 0) {
            const newCount = (data.daily_count || 0) + guestUsed;
            let syncResult;
            try {
              syncResult = await sb
                .from('user_usage')
                .update({ daily_count: newCount })
                .eq('id', currentUser.id);
            } catch (syncErr) {
              // Syncエラーでも続行
              console.error('Usage Init: Sync error (continuing with defaults):', syncErr);
              syncResult = { error: syncErr };
            }

            const { error: syncError } = syncResult;

            if (!syncError) {
              data.daily_count = newCount;
              setGuestUsage(0);
            } else {
              // エラー時でもメモリ上の値を更新
              data.daily_count = newCount;
            }
          }

          currentUsage = data;
        } else {
          // dataがnullの場合もデフォルト値をセット
          currentUsage = { 
            id: currentUser.id, 
            daily_count: 0, 
            last_reset_date: today, 
            is_premium: false,
            subscription_status: null,
            next_billing_date: null
          };
        }

        // モック: Premiumユーザーの場合、サブスクリプション情報を設定
        if (currentUsage.is_premium) {
          // DBから取得したデータに subscription_status がない場合は、モックで設定
          if (!currentUsage.subscription_status) {
            // モック: デフォルトは 'active'（契約中）
            currentUsage.subscription_status = 'active';
          }
          if (!currentUsage.next_billing_date) {
            // モック: 次回更新日を計算（1ヶ月後）
            currentUsage.next_billing_date = getNextBillingDate();
          }
        } else {
          // 無料プランの場合は null
          currentUsage.subscription_status = null;
          currentUsage.next_billing_date = null;
        }

      } catch (e) {
        // ★包括的エラーハンドリング: 何が起きてもデフォルト値で動かす
        // アラートは絶対に表示しない
        console.error('Unexpected error in fetchUsage:', e);
        currentUsage = { 
          id: currentUser.id, 
          daily_count: 0, 
          last_reset_date: today, 
          is_premium: false,
          subscription_status: null,
          next_billing_date: null
        };
      }

      // 最終的にcurrentUsageがセットされていることを確認
      if (!currentUsage || !currentUsage.id) {
        currentUsage = { 
          id: currentUser.id, 
          daily_count: 0, 
          last_reset_date: today, 
          is_premium: false,
          subscription_status: null,
          next_billing_date: null
        };
      }

      updateHeaderUI();
    }

    async function incrementUsage(count) {
      if (!currentUser || !sb) return;

      // Optimistic update
      currentUsage.daily_count += count;
      updateHeaderUI();

      // DB Update
      const { error } = await sb
        .from('user_usage')
        .update({ daily_count: currentUsage.daily_count })
        .eq('id', currentUser.id);

      if (error) {
        console.error('Increment Usage Error:', error);
        alert('利用回数の更新に失敗しました。ネットワーク接続を確認してください。');
        // Rollback UI
        currentUsage.daily_count -= count;
        updateHeaderUI();
      }
    }

    function updateHeaderUI() {
      const planName = document.getElementById('planName');
      const usageText = document.getElementById('usageText');
      const planLink = document.querySelector('#planBadge a[onclick="openPremiumModal()"]');

      if (currentUsage.is_premium) {
        planName.textContent = 'Premium Plan';
        planName.className = 'bg-yellow-100 text-yellow-800 font-bold px-3 py-1 rounded-full text-sm';
        usageText.textContent = '無制限で利用可能';
        // Premiumユーザーの場合は「契約確認」に変更
        if (planLink) {
          planLink.textContent = '契約確認';
        }
      } else {
        planName.textContent = 'Free Plan';
        planName.className = 'bg-gray-200 text-gray-700 font-bold px-3 py-1 rounded-full text-sm';
        usageText.textContent = `本日利用数: ${currentUsage.daily_count}/${FREE_LIMIT}`;
        if (currentUsage.daily_count >= FREE_LIMIT) {
          usageText.classList.add('text-red-500', 'font-bold');
        } else {
          usageText.classList.remove('text-red-500', 'font-bold');
        }
        // 無料プランユーザーの場合は「プラン変更」に戻す
        if (planLink) {
          planLink.textContent = 'プラン変更';
        }
      }
      // Also update pricing section
      updatePricingUI();
      updateCTALink();
    }

    function updatePricingUI() {
      const freeBtn = document.getElementById('freePlanBtn');
      const premiumBtn = document.getElementById('premiumCTA');

      if (!currentUser) {
        // Guest mode
        freeBtn.textContent = 'ログインして使う';
        freeBtn.disabled = false;
        freeBtn.onclick = openLoginModal;
        freeBtn.className = 'w-full py-2 px-4 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition';

        premiumBtn.textContent = '登録して無制限にする';
        premiumBtn.disabled = false;
        premiumBtn.onclick = () => openSignupModal();
        premiumBtn.className = 'w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105';
      } else if (currentUsage.is_premium) {
        // Premium user
        freeBtn.textContent = '-';
        freeBtn.disabled = true;
        freeBtn.onclick = null;
        freeBtn.className = 'w-full py-2 px-4 bg-gray-100 text-gray-400 rounded-lg font-medium cursor-not-allowed';

        premiumBtn.textContent = '現在契約中のプラン';
        premiumBtn.disabled = true;
        premiumBtn.onclick = null;
        premiumBtn.className = 'w-full py-3 px-4 bg-green-500 text-white rounded-lg font-bold shadow-lg cursor-not-allowed';
      } else {
        // Free logged-in user
        freeBtn.textContent = '利用中';
        freeBtn.disabled = true;
        freeBtn.onclick = null;
        freeBtn.className = 'w-full py-2 px-4 bg-blue-100 text-blue-700 rounded-lg font-medium cursor-not-allowed';

        premiumBtn.textContent = 'プレミアムにアップグレード';
        premiumBtn.disabled = false;
        premiumBtn.onclick = () => openPremiumModal();
        premiumBtn.className = 'w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105';
      }
    }

    // Helper: Format date from YYYY-MM-DD to YYYY/MM/DD
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return dateStr.replace(/-/g, '/');
    }

    function openPremiumModal() {
      document.getElementById('premiumModal').classList.remove('hidden');
      
      // 3つのパターンで表示を切り替え
      const freeView = document.getElementById('premiumModalFree');
      const activeView = document.getElementById('premiumModalActive');
      const canceledView = document.getElementById('premiumModalCanceled');
      
      // すべて非表示にする
      if (freeView) freeView.classList.add('hidden');
      if (activeView) activeView.classList.add('hidden');
      if (canceledView) canceledView.classList.add('hidden');
      
      // ユーザーの状態に応じて表示
      if (currentUsage.is_premium) {
        if (currentUsage.subscription_status === 'canceled') {
          // Pattern C: Premium（解約済み・期限内）
          if (canceledView) {
            canceledView.classList.remove('hidden');
            const expiryDateEl = document.getElementById('premiumExpiryDate');
            if (expiryDateEl && currentUsage.next_billing_date) {
              expiryDateEl.textContent = formatDate(currentUsage.next_billing_date);
            }
          }
        } else {
          // Pattern B: Premium（契約中）
          if (activeView) {
            activeView.classList.remove('hidden');
            const nextBillingDateEl = document.getElementById('premiumNextBillingDate');
            if (nextBillingDateEl && currentUsage.next_billing_date) {
              nextBillingDateEl.textContent = formatDate(currentUsage.next_billing_date);
            }
          }
        }
      } else {
        // Pattern A: 無料プランユーザー
        if (freeView) {
          freeView.classList.remove('hidden');
          const msg = document.getElementById('premiumMessage');
          if (msg) msg.textContent = '';
        }
      }
    }

    function closePremiumModal() {
      document.getElementById('premiumModal').classList.add('hidden');
    }

    async function cancelSubscription(btnElement) {
      // 確認ダイアログ
      if (!confirm('サブスクリプションの自動更新を停止しますか？\n\n現在のプランは有効期限まで利用可能です。')) {
        return;
      }

      if (!currentUser) return;

      // ボタン連打防止
      const btn = btnElement || document.getElementById('cancelSubscriptionBtn');
      if (!btn) return;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '処理中...';

      try {
        // モック: ローカルでステータスを更新
        currentUsage.subscription_status = 'canceled';
        // 有効期限は next_billing_date をそのまま使用（変更しない）

        // 実際のアプリでは、ここでバックエンドAPIを呼び出してDBを更新
        // モックのため、ローカルのみで更新
        console.log('Subscription canceled (mock):', currentUsage);

        // UIを更新
        updateHeaderUI();
        closePremiumModal();
        alert('サブスクリプションの自動更新を停止しました。\n有効期限までPremiumプランをご利用いただけます。');
      } catch (e) {
        console.error('Cancel subscription error:', e);
        alert('エラーが発生しました。もう一度お試しください。');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function resumeSubscription(btnElement) {
      // 確認ダイアログ
      if (!confirm('サブスクリプションを再開しますか？\n\n次回の更新日から自動更新が再開されます。')) {
        return;
      }

      if (!currentUser) return;

      // ボタン連打防止
      const btn = btnElement || document.getElementById('resumeSubscriptionBtn');
      if (!btn) return;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '処理中...';

      try {
        // モック: ローカルでステータスを更新
        currentUsage.subscription_status = 'active';
        // 次回更新日を再計算（1ヶ月後）
        currentUsage.next_billing_date = getNextBillingDate();

        // 実際のアプリでは、ここでバックエンドAPIを呼び出してDBを更新
        // モックのため、ローカルのみで更新
        console.log('Subscription resumed (mock):', currentUsage);

        // UIを更新
        updateHeaderUI();
        closePremiumModal();
        alert('サブスクリプションを再開しました。\n次回の更新日から自動更新が再開されます。');
      } catch (e) {
        console.error('Resume subscription error:', e);
        alert('エラーが発生しました。もう一度お試しください。');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function subscribeToPremium(btnElement) {
      if (!currentUser || !sb) {
        alert('ログインが必要です。');
        return;
      }

      // ボタン連打防止
      const btn = btnElement || document.querySelector('button[onclick*="subscribeToPremium"]');
      let originalText = '今すぐ登録する';
      if (btn) {
        originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '処理中...';
      }

      try {
        // Supabase Edge Functionを呼び出してStripe Checkout Sessionを作成
        const { data, error } = await sb.functions.invoke('create-checkout-session', {
          body: {}
        });

        if (error) {
          console.error('Checkout session creation error:', error);
          alert('決済セッションの作成に失敗しました。もう一度お試しください。');
          return;
        }

        if (!data || !data.url) {
          console.error('Invalid response from create-checkout-session:', data);
          alert('決済ページのURLを取得できませんでした。もう一度お試しください。');
          return;
        }

        // Stripeの決済ページにリダイレクト
        window.location.href = data.url;
      } catch (e) {
        console.error('Unexpected error in subscribeToPremium:', e);
        alert('エラーが発生しました。もう一度お試しください。');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }
    }

    async function openPortal(btnElement) {
      if (!currentUser || !sb) {
        alert('ログインが必要です。');
        return;
      }

      // ボタン連打防止
      const btn = btnElement || document.getElementById('openPortalBtn');
      let originalText = '領収書・支払い履歴の確認（Stripe）';
      if (btn) {
        originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '処理中...';
      }

      try {
        // Supabase Edge Functionを呼び出してStripe Customer Portal Sessionを作成
        const { data, error } = await sb.functions.invoke('create-portal-session', {
          body: {}
        });

        if (error) {
          console.error('Portal session creation error:', error);
          alert('ポータルセッションの作成に失敗しました。もう一度お試しください。');
          return;
        }

        if (!data || !data.url) {
          console.error('Invalid response from create-portal-session:', data);
          alert('ポータルページのURLを取得できませんでした。もう一度お試しください。');
          return;
        }

        // Stripeのカスタマーポータルにリダイレクト
        window.location.href = data.url;
      } catch (e) {
        console.error('Unexpected error in openPortal:', e);
        alert('エラーが発生しました。もう一度お試しください。');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }
    }

    // Check for Stripe checkout success with polling
    async function checkStripeCheckoutSuccess() {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('session_id');
      
      if (!sessionId) {
        return; // No session_id, exit early
      }

      // Wait for user to be loaded
      if (!currentUser) {
        // Retry after a short delay if user is not loaded yet
        setTimeout(() => {
          checkStripeCheckoutSuccess();
        }, 500);
        return;
      }

      // Show loading overlay
      const loadingOverlay = document.getElementById('stripeCheckoutLoading');
      const statusText = document.getElementById('stripeCheckoutStatus');
      if (loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
      }

      // Polling configuration
      const pollInterval = 2000; // 2 seconds
      const maxWaitTime = 20000; // 20 seconds
      const startTime = Date.now();
      let pollCount = 0;

      const pollUsage = async () => {
        pollCount++;
        const elapsed = Date.now() - startTime;

        // Update status text
        if (statusText) {
          statusText.textContent = `確認中... (${Math.floor(elapsed / 1000)}秒)`;
        }

        try {
          // Fetch current usage from database
          if (!currentUser || !sb) {
            throw new Error('User or Supabase client not available');
          }

          const { data, error } = await sb
            .from('user_usage')
            .select('*')
            .eq('id', currentUser.id)
            .maybeSingle();

          if (error) {
            console.error('Error fetching usage:', error);
            // Continue polling even on error
          } else if (data) {
            // Check if premium status is active
            const isPremium = data.is_premium === true;
            const subscriptionStatus = data.subscription_status;

            // Check if subscription is active (either is_premium is true or subscription_status is 'active')
            if (isPremium || subscriptionStatus === 'active') {
              // Success! Update currentUsage and UI
              currentUsage = {
                ...currentUsage,
                is_premium: true,
                subscription_status: subscriptionStatus || 'active',
                stripe_customer_id: data.stripe_customer_id || currentUsage.stripe_customer_id,
                next_billing_date: data.next_billing_date || currentUsage.next_billing_date,
              };

              // Hide loading overlay
              if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
              }

              // Update UI
              updateHeaderUI();

              // Remove session_id from URL
              const newUrl = window.location.pathname;
              window.history.replaceState({}, '', newUrl);

              // Show success message
              alert('プレミアムプランへの登録が完了しました！\n\nアップグレードありがとうございます！');

              // Open premium modal to show subscription details
              setTimeout(() => {
                openPremiumModal();
              }, 500);

              return; // Exit polling
            }
          }

          // Check timeout
          if (elapsed >= maxWaitTime) {
            // Timeout reached
            if (loadingOverlay) {
              loadingOverlay.classList.add('hidden');
            }

            // Remove session_id from URL
            const newUrl = window.location.pathname;
            window.history.replaceState({}, '', newUrl);

            alert('反映に時間がかかっています。\n後ほどページをリロードしてください。\n\nもし問題が続く場合は、お問い合わせフォームからご連絡ください。');
            return; // Exit polling
          }

          // Continue polling
          setTimeout(pollUsage, pollInterval);
        } catch (error) {
          console.error('Error in pollUsage:', error);
          
          // Check timeout even on error
          const elapsed = Date.now() - startTime;
          if (elapsed >= maxWaitTime) {
            if (loadingOverlay) {
              loadingOverlay.classList.add('hidden');
            }
            const newUrl = window.location.pathname;
            window.history.replaceState({}, '', newUrl);
            alert('反映に時間がかかっています。\n後ほどページをリロードしてください。');
            return;
          }

          // Continue polling even on error
          setTimeout(pollUsage, pollInterval);
        }
      };

      // Start polling after initial delay (give webhook time to process)
      setTimeout(() => {
        pollUsage();
      }, 1000);
    }

    // Initialize UI
    initSupabase();
    
    // Check for Stripe checkout success after initialization
    setTimeout(() => {
      checkStripeCheckoutSuccess();
    }, 1000);


    // --- Existing App Logic (Sortable, Rename, etc.) ---
    Sortable.create(listContainer, {
      animation: 150,
      ghostClass: 'ghost',
      handle: '.cursor-move',
      onEnd: function () {
        syncDataWithDOM();
        updateSortInputs();
        updateFilenames();
      }
    });

    const fileInput = document.getElementById('fileInput');
    const dropZones = document.querySelectorAll('.drop-zone-target');

    // Add event listeners to all drop zones
    dropZones.forEach(dropZone => {
      dropZone.addEventListener('click', () => {
        fileInput.click();
      });

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        // Get the text element for this specific drop zone
        const dropZoneText = dropZone.querySelector('.drop-zone-text');
        const originalText = dropZoneText ? dropZoneText.textContent : '';
        
        // Check if files were dropped (local files)
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
          handleFiles(e.dataTransfer.files);
          return;
        }

        // Check if URL/image was dropped (web image)
        const url = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/html');
        if (url) {
          // Extract image URL from HTML if needed
          let imageUrl = url;
          if (url.includes('<img')) {
            const imgMatch = url.match(/src=["']([^"']+)["']/i);
            if (imgMatch) {
              imageUrl = imgMatch[1];
            } else {
              return; // Could not extract URL
            }
          }

          // Validate if it's an image URL
          if (!imageUrl.match(/\.(jpg|jpeg|png|gif|webp)(\?|$)/i) && !imageUrl.startsWith('data:image/')) {
            // Try to fetch and check content type
            try {
              const response = await fetch(imageUrl, { method: 'HEAD', mode: 'no-cors' });
              // If we can't check, proceed anyway
            } catch (err) {
              // Continue to try fetching
            }
          }

          // Update drop zone text for this specific drop zone
          if (dropZoneText) {
            dropZoneText.textContent = 'Web画像を読み込み中...';
          }

          try {
          // Fetch the image
          const response = await fetch(imageUrl);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const blob = await response.blob();
          
          // Check if it's an image
          if (!blob.type.startsWith('image/')) {
            throw new Error('Not an image file');
          }

          // Convert blob to File object
          // Remove query parameters and fragments from URL
          const urlWithoutParams = imageUrl.split('?')[0].split('#')[0];
          
          // Extract filename from clean URL
          let fileName = urlWithoutParams.split('/').pop() || '';
          
          // Helper function to get extension from MIME type
          const getExtensionFromMimeType = (mimeType) => {
            const mimeMap = {
              'image/jpeg': 'jpg',
              'image/jpg': 'jpg',
              'image/png': 'png',
              'image/gif': 'gif',
              'image/webp': 'webp',
              'image/svg+xml': 'svg',
              'image/bmp': 'bmp',
              'image/tiff': 'tiff',
            };
            return mimeMap[mimeType] || 'jpg';
          };
          
          // Validate filename and add extension if needed
          if (!fileName || !fileName.includes('.')) {
            // Filename is invalid or has no extension
            const extension = getExtensionFromMimeType(blob.type);
            fileName = `web-image.${extension}`;
          } else {
            // Filename exists, but ensure it has a valid extension
            const fileExtension = fileName.split('.').pop().toLowerCase();
            const validExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'tiff'];
            if (!validExtensions.includes(fileExtension)) {
              // Invalid extension, replace with one from MIME type
              const extension = getExtensionFromMimeType(blob.type);
              const nameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.'));
              fileName = nameWithoutExt ? `${nameWithoutExt}.${extension}` : `web-image.${extension}`;
            }
          }
          
          const file = new File([blob], fileName, { type: blob.type || `image/${getExtensionFromMimeType(blob.type)}` });

          // Create a FileList-like object
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          const fileList = dataTransfer.files;

          // Handle the file
          handleFiles(fileList);
        } catch (error) {
          console.error('Error loading web image:', error);
          alert('セキュリティ制限により、このWeb画像を読み込めませんでした。\n\n画像を一度パソコンに保存してからアップロードしてください。');
          } finally {
            // Restore original text for this specific drop zone
            if (dropZoneText) {
              dropZoneText.textContent = originalText || 'ファイルをここにドラッグ＆ドロップ';
            }
          }
          return;
        }

        // If neither files nor URL, do nothing
      });
    });

    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(files) {
      if (files.length === 0) return;
      Array.from(files).forEach(file => {
        const id = Math.random().toString(36).substr(2, 9);
        if (file.type.startsWith('image/')) {
          // 画像の場合はFileReaderで読み込んで追加
          const reader = new FileReader();
          reader.onload = (e) => addFileToUI(id, file, e.target.result);
          reader.readAsDataURL(file);
        } else {
          // その他のファイルはアイコン表示のみ
          addFileToUI(id, file, null);
        }
      });
      
      // Scroll to settings section for better UX
      if (files.length > 0) {
        setTimeout(() => {
          const settingsSection = document.getElementById('renameSettings');
          if (settingsSection) {
            settingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100); // わずかな遅延を入れて自然な動作にする
      }
    }

    function addFileToUI(id, file, src) {
      const template = document.getElementById('imageItemTemplate');
      const clone = template.content.cloneNode(true);
      const root = clone.querySelector('.image-item');
      root.setAttribute('data-id', id);
      
      const imgElement = root.querySelector('img');
      const thumbnailContainer = imgElement.closest('div');
      
      // ファイルタイプに応じてアイコンを表示
      if (file.type.startsWith('image/') && src) {
        // 画像の場合はプレビュー画像を表示
        imgElement.src = src;
      } else {
        // その他のファイルはアイコン表示
        imgElement.style.display = 'none';
        const fileIcon = document.createElement('div');
        fileIcon.className = 'w-20 h-20 rounded-md flex items-center justify-center border flex-shrink-0';
        
        // ファイルタイプに応じてアイコンと色を決定
        let iconHtml = '';
        let bgColor = '';
        let borderColor = '';
        let textColor = '';
        let fileTypeLabel = '';
        
        if (file.type === 'application/pdf') {
          // PDF
          bgColor = 'bg-red-100';
          borderColor = 'border-red-200';
          textColor = 'text-red-600';
          fileTypeLabel = 'PDF';
          iconHtml = `
            <svg class="w-10 h-10 mx-auto ${textColor} mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
          `;
        } else if (file.type.startsWith('video/')) {
          // 動画
          bgColor = 'bg-purple-100';
          borderColor = 'border-purple-200';
          textColor = 'text-purple-600';
          fileTypeLabel = '動画';
          iconHtml = `
            <svg class="w-10 h-10 mx-auto ${textColor} mb-1" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"></path>
            </svg>
          `;
        } else if (file.name.match(/\.(xlsx|xls|csv)$/i) || file.type.includes('spreadsheet') || file.type.includes('excel')) {
          // Excel/CSV
          bgColor = 'bg-green-100';
          borderColor = 'border-green-200';
          textColor = 'text-green-600';
          fileTypeLabel = 'Excel';
          iconHtml = `
            <svg class="w-10 h-10 mx-auto ${textColor} mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
          `;
        } else if (file.name.match(/\.(docx|doc)$/i) || file.type.includes('word') || file.type.includes('document')) {
          // Word
          bgColor = 'bg-blue-100';
          borderColor = 'border-blue-200';
          textColor = 'text-blue-600';
          fileTypeLabel = 'Word';
          iconHtml = `
            <svg class="w-10 h-10 mx-auto ${textColor} mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          `;
        } else if (file.name.match(/\.(pptx|ppt)$/i) || file.type.includes('presentation') || file.type.includes('powerpoint')) {
          // PowerPoint
          bgColor = 'bg-orange-100';
          borderColor = 'border-orange-200';
          textColor = 'text-orange-600';
          fileTypeLabel = 'PPT';
          iconHtml = `
            <svg class="w-10 h-10 mx-auto ${textColor} mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
            </svg>
          `;
        } else {
          // その他
          bgColor = 'bg-gray-100';
          borderColor = 'border-gray-200';
          textColor = 'text-gray-600';
          fileTypeLabel = 'ファイル';
          iconHtml = `
            <svg class="w-10 h-10 mx-auto ${textColor} mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
          `;
        }
        
        fileIcon.className = `w-20 h-20 ${bgColor} rounded-md flex items-center justify-center ${borderColor} border flex-shrink-0`;
        fileIcon.innerHTML = `
          <div class="text-center">
            ${iconHtml}
            <span class="text-xs font-bold ${textColor}">${fileTypeLabel}</span>
          </div>
        `;
        thumbnailContainer.appendChild(fileIcon);
      }
      
      root.querySelector('.original-name').textContent = `元ファイル: ${file.name}`;
      const radios = root.querySelectorAll('input[type="radio"]');
      radios.forEach(radio => radio.name = `mode-${id}`);
      listContainer.appendChild(root);
      imageData.push({
        id: id,
        file: file,
        mode: 'default',
        customText: '',
        element: root,
        sortIndex: imageData.length + 1
      });
      root.querySelector('.sort-input').value = imageData.length;
      updateUIState();
      updateFilenames();
    }

    function removeImage(btn) {
      const item = btn.closest('.image-item');
      const id = item.getAttribute('data-id');
      item.remove();
      imageData = imageData.filter(img => img.id !== id);
      updateSortInputs();
      updateUIState();
      updateFilenames();
    }

    function clearAll() {
      if (!confirm('全てのファイルを削除しますか？')) return;
      listContainer.innerHTML = '';
      imageData = [];
      document.getElementById('fileInput').value = ''; // Reset file input
      updateUIState();
      updateFilenames();
    }

    function updateUIState() {
      const count = imageData.length;
      document.getElementById('imageCount').textContent = `(${count}枚)`;
      document.getElementById('emptyState').style.display = count === 0 ? 'block' : 'none';
    }

    window.updateRowMode = function (radio) {
      const item = radio.closest('.image-item');
      const id = item.getAttribute('data-id');
      const mode = radio.value;
      const dataItem = imageData.find(img => img.id === id);
      if (dataItem) dataItem.mode = mode;
      const customInput = item.querySelector('.custom-input-container');
      if (mode === 'custom') {
        customInput.classList.remove('hidden');
        customInput.querySelector('input').focus();
      } else {
        customInput.classList.add('hidden');
      }
      updateFilenames();
    }

    function syncDataWithDOM() {
      const currentIds = Array.from(listContainer.children).map(el => el.getAttribute('data-id'));
      const newData = [];
      currentIds.forEach(id => {
        const item = imageData.find(img => img.id === id);
        if (item) newData.push(item);
      });
      imageData = newData;
    }

    function updateSortInputs() {
      const inputs = listContainer.querySelectorAll('.sort-input');
      inputs.forEach((input, index) => {
        input.value = index + 1;
      });
    }

    window.manualSort = function (input) {
      const item = input.closest('.image-item');
      const id = item.getAttribute('data-id');
      const newIndex = parseFloat(input.value);
      const dataItem = imageData.find(img => img.id === id);
      if (dataItem) dataItem.tempSortIndex = newIndex;
      const children = Array.from(listContainer.children);
      let sortList = children.map((el, index) => {
        const elId = el.getAttribute('data-id');
        let val = index + 1;
        if (elId === id) {
          val = newIndex;
        }
        return {
          id: elId,
          val: val,
          element: el
        };
      });
      sortList.sort((a, b) => a.val - b.val);
      sortList.forEach(obj => {
        listContainer.appendChild(obj.element);
      });
      syncDataWithDOM();
      updateSortInputs();
      updateFilenames();
    }

    function toggleMinDigits() {
      const type = document.getElementById('seqType').value;
      const container = document.getElementById('minDigitsContainer');
      if (type.startsWith('alphabet')) {
        container.classList.add('opacity-50', 'pointer-events-none');
      } else {
        container.classList.remove('opacity-50', 'pointer-events-none');
      }
    }

    function toAlpha(num) {
      let s = '';
      while (num >= 0) {
        s = String.fromCharCode(num % 26 + 65) + s;
        num = Math.floor(num / 26) - 1;
      }
      return s;
    }

    function updateFilenames() {
      const prefix = document.getElementById('prefix').value;
      const suffix = document.getElementById('suffix').value;
      const seqType = document.getElementById('seqType').value;
      let minDigits = parseInt(document.getElementById('minDigits').value) || 1;
      if (minDigits < 1) minDigits = 1;
      if (minDigits > 12) minDigits = 12;
      let startNumber = parseInt(document.getElementById('startNumber').value) || 1;
      if (startNumber < 0) startNumber = 0;

      let counter = 0;

      imageData.forEach(img => {
        const input = img.element.querySelector('.custom-input-container input');
        if (input) img.customText = input.value.trim();
      });

      imageData.forEach(img => {
        let newName = '';
        const ext = img.file.name.split('.').pop();

        let core = '';
        if (img.mode === 'custom') {
          core = img.customText;
        } else {
          if (seqType === 'number') {
            let numStr = (counter + startNumber).toString();
            if (numStr.length < minDigits) {
              numStr = numStr.padStart(minDigits, '0');
            }
            core = numStr;
          } else {
            // 開始番号1ならA、2ならB...になるように調整（toAlphaは0ベースなので-1）
            const alphaIndex = counter + startNumber - 1;
            let alphaResult = toAlpha(alphaIndex < 0 ? 0 : alphaIndex);
            // 連番タイプに応じて大文字・小文字を適用
            if (seqType === 'alphabet-upper') {
              core = alphaResult.toUpperCase();
            } else if (seqType === 'alphabet-lower') {
              core = alphaResult.toLowerCase();
            } else {
              core = alphaResult; // フォールバック（通常は到達しない）
            }
          }
          counter++;
        }

        newName = `${prefix}${core}${suffix}.${ext}`;
        const previewEl = img.element.querySelector('.filename-preview');
        if (previewEl) previewEl.textContent = newName;
        img.finalName = newName;
      });

      // Update settings preview
      updatePreview();
    }

    function updatePreview() {
      const prefix = document.getElementById('prefix').value || 'IMG_';
      const suffix = document.getElementById('suffix').value || '';
      const seqType = document.getElementById('seqType').value;
      let minDigits = parseInt(document.getElementById('minDigits').value) || 3;
      if (minDigits < 1) minDigits = 1;
      if (minDigits > 12) minDigits = 12;
      let startNumber = parseInt(document.getElementById('startNumber').value) || 1;
      if (startNumber < 0) startNumber = 0;

      let core = '';
      if (seqType === 'number') {
        core = startNumber.toString().padStart(minDigits, '0');
      } else {
        // 開始番号1ならA/a、2ならB/b...になるように調整（toAlphaは0ベースなので-1）
        const alphaIndex = startNumber - 1;
        let alphaResult = toAlpha(alphaIndex < 0 ? 0 : alphaIndex);
        // 連番タイプに応じて大文字・小文字を適用
        if (seqType === 'alphabet-upper') {
          core = alphaResult.toUpperCase();
        } else if (seqType === 'alphabet-lower') {
          core = alphaResult.toLowerCase();
        } else {
          core = alphaResult; // フォールバック（通常は到達しない）
        }
      }

      const preview = `${prefix}${core}${suffix}.jpg`;
      const previewEl = document.getElementById('previewFilename');
      if (previewEl) previewEl.textContent = preview;
    }

    // Initialize preview on load
    // ページ読み込み時にプレビューを確実に表示（開始番号1、最小桁数3で001と表示）
    updatePreview();
    
    // 画像が既に読み込まれている場合も更新
    if (imageData.length > 0) {
      updateFilenames();
    }
    
    // Sync download format select boxes
    syncDownloadFormat();

    // Sync download format select boxes
    function syncDownloadFormat() {
      const formatTop = document.getElementById('downloadFormat');
      const formatBottom = document.getElementById('downloadFormatBottom');
      const noticeTop = document.getElementById('downloadFormatNotice');
      const noticeBottom = document.getElementById('downloadFormatNoticeBottom');
      
      if (formatTop && formatBottom) {
        // Sync both select boxes
        formatTop.addEventListener('change', () => {
          formatBottom.value = formatTop.value;
          updateDownloadNotice();
        });
        formatBottom.addEventListener('change', () => {
          formatTop.value = formatBottom.value;
          updateDownloadNotice();
        });
      }
      
      updateDownloadNotice();
    }
    
    function updateDownloadNotice() {
      const formatTop = document.getElementById('downloadFormat')?.value || 'zip';
      const formatBottom = document.getElementById('downloadFormatBottom')?.value || 'zip';
      const format = formatTop || formatBottom || 'zip';
      const noticeTop = document.getElementById('downloadFormatNotice');
      const noticeBottom = document.getElementById('downloadFormatNoticeBottom');
      
      if (format === 'individual') {
        if (noticeTop) noticeTop.classList.remove('hidden');
        if (noticeBottom) noticeBottom.classList.remove('hidden');
      } else {
        if (noticeTop) noticeTop.classList.add('hidden');
        if (noticeBottom) noticeBottom.classList.add('hidden');
      }
    }

    async function downloadFiles() {
      if (imageData.length === 0) {
        alert('ファイルを追加してください。');
        return;
      }

      // --- Limit Check ---
      if (currentUser) {
        // Logged-in user: check Supabase data
        if (!currentUsage.is_premium && imageData.length >= 20) {
          openPremiumModal();
          document.getElementById('premiumMessage').textContent = '20枚以上を一括変換するには、プレミアムプランへのアップグレードが必要です。';
          return;
        }
      } else {
        // Guest user: check localStorage
        if (imageData.length >= 20) {
          // Show signup modal with custom alert
          sessionStorage.setItem('pending_action', 'premium_promote');
          openSignupModal();
          const limitAlert = document.getElementById('signupLimitAlert');
          if (limitAlert) limitAlert.classList.remove('hidden');
          document.getElementById('signupMessage').textContent = '';
          return;
        }
      }

      // Get download format
      const downloadFormat = document.getElementById('downloadFormat')?.value || 
                            document.getElementById('downloadFormatBottom')?.value || 
                            'zip';

      // Check for duplicate filenames
      const usedNames = new Set();
      for (const img of imageData) {
        if (usedNames.has(img.finalName)) {
          alert(`エラー: ファイル名が重複しています - ${img.finalName}\n設定や手入力を調整してください。`);
          return;
        }
        usedNames.add(img.finalName);
      }

      const btn = document.querySelector('button[onclick="downloadFiles()"]');
      const originalText = btn ? btn.innerHTML : '';
      if (btn) {
        btn.innerHTML = '処理中...';
        btn.disabled = true;
      }

      try {
        if (downloadFormat === 'zip') {
          // ZIP形式でダウンロード
          const zip = new JSZip();
          for (const img of imageData) {
            zip.file(img.finalName, img.file);
          }
          const content = await zip.generateAsync({ type: "blob" });
          const zipName = document.getElementById('prefix').value ? `${document.getElementById('prefix').value}_files.zip` : 'files.zip';
          saveAs(content, zipName);
        } else {
          // 個別ファイルとしてダウンロード
          for (const img of imageData) {
            saveAs(img.file, img.finalName);
            // 少し待機してから次のファイルをダウンロード（ブラウザの通知を避けるため）
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }

        // Update Usage
        if (currentUser) {
          await incrementUsage(imageData.length);
        } else {
          setGuestUsage(getGuestUsage() + imageData.length);
        }

      } catch (e) {
        console.error(e);
        alert('ダウンロード中にエラーが発生しました。');
      } finally {
        if (btn) {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }
    }

    // Legacy function for backward compatibility
    async function downloadZip() {
      // Set format to zip and call downloadFiles
      const formatTop = document.getElementById('downloadFormat');
      const formatBottom = document.getElementById('downloadFormatBottom');
      if (formatTop) formatTop.value = 'zip';
      if (formatBottom) formatBottom.value = 'zip';
      updateDownloadNotice();
      await downloadFiles();
    }
  </script>
</body>

</html>
